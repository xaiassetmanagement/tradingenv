<!DOCTYPE html>

<html lang="env" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tradingenv.metrics &#8212; tradingenv 0.1.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=17e93383"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for tradingenv.metrics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;It is harder to convert returns to levels than viceversa because the former</span>
<span class="sd">requires to know what was the base date.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.core.generic</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDFrame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">OLS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.regression.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegressionResultsWrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Number</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.cluster.hierarchy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cluster</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>

<span class="n">BDAYS</span> <span class="o">=</span> <span class="mi">252</span>


<div class="viewcode-block" id="to_pandas">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.metrics.to_pandas">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_pandas</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">NDFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This decorator simply adds method to the signature of cls, which is</span>
<span class="sd">    NDFrame by default.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : Callable</span>
<span class="sd">        A function definition whose first argument is an instance of cls.</span>
<span class="sd">    target : Type</span>
<span class="sd">        A class type. Input &#39;method&#39; will be set as attribute of this &#39;target&#39;</span>
<span class="sd">        class.</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    When optional arguments are passed to properties, then the first argument</span>
<span class="sd">    (&#39;method&#39; in this case) is None. This requires special handling, managed</span>
<span class="sd">    by the big if-else below. The implementation has been inspired by:</span>
<span class="sd">    https://stackoverflow.com/a/24617244/7677636</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame()</span>
<span class="sd">    &gt;&gt;&gt; series = pd.Series(dtype=float)</span>
<span class="sd">    &gt;&gt;&gt; # df.method()  # raises</span>
<span class="sd">    &gt;&gt;&gt; # series.method()  # raises</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; @to_pandas(target=pd.DataFrame)</span>
<span class="sd">    ... def method(frame: NDFrame):</span>
<span class="sd">    ...     return &#39;Hello!&#39;</span>
<span class="sd">    &gt;&gt;&gt; df.method()</span>
<span class="sd">    &#39;Hello!&#39;</span>
<span class="sd">    &gt;&gt;&gt; # series.method()  # AttributeError: &#39;Series&#39; object has no attribute &#39;method&#39;</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; @to_pandas(target=pd.Series)</span>
<span class="sd">    ... def method(frame: NDFrame):</span>
<span class="sd">    ...     return &#39;Hello!&#39;</span>
<span class="sd">    &gt;&gt;&gt; df.method()</span>
<span class="sd">    &#39;Hello!&#39;</span>
<span class="sd">    &gt;&gt;&gt; series.method()</span>
<span class="sd">    &#39;Hello!&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;to_pandas only supports keyword arguments.&quot;</span><span class="p">)</span>
    <span class="n">optional_kwargs</span> <span class="o">=</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">optional_kwargs</span><span class="p">:</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">method</span>

        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">PandasMetrics</span><span class="p">(</span><span class="n">NDFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define here methods to be added to pandas.Series AND pandas.DataFrame</span>
<span class="sd">    using the decorator to_pandas. All these methods assume that data are</span>
<span class="sd">    daily levels.&quot;&quot;&quot;</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that the data is a proper level dataset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing values are not allowed.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;This method can only work with level data, so &quot;</span>
                <span class="s2">&quot;all values must be positive.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">has_duplicates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate indices have been found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input index must be a DatetimeIndex&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input must not missing values in the index.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input index must be monotonic increasing.&quot;</span><span class="p">)</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the object itself, which is assumed to be a level. In case</span>
<span class="sd">        of duplicate dates, only the last timestamp for each day will be kept.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simple_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.Series([1, 2, 3], pd.date_range(&#39;2019-01-01&#39;, periods=3))</span>
<span class="sd">        &gt;&gt;&gt; prices.simple_returns()</span>
<span class="sd">        2019-01-02    1.0</span>
<span class="sd">        2019-01-03    0.5</span>
<span class="sd">        Freq: D, dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/pandas-dev/pandas/issues/6389</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="c1"># FutureWarning: The &#39;fill_method&#39; and &#39;limit&#39; keywords in</span>
        <span class="c1"># Series.pct_change are deprecated and will be removed in a future</span>
        <span class="c1"># version. Call ffill before calling pct_change instead.</span>
        <span class="n">simple_returns</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>  <span class="c1"># fill_method=None</span>
        <span class="k">return</span> <span class="n">simple_returns</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.Series([1, 2, 3], pd.date_range(&#39;2019-01-01&#39;, periods=3))</span>
<span class="sd">        &gt;&gt;&gt; prices.log_returns()</span>
<span class="sd">        2019-01-02    0.693147</span>
<span class="sd">        2019-01-03    0.405465</span>
<span class="sd">        Freq: D, dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">log_returns</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nr_calendar_days</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=5, freq=&#39;B&#39;),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.nr_calendar_days()</span>
<span class="sd">        6</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">())</span><span class="o">.</span><span class="n">days</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nr_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=5, freq=&#39;B&#39;),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.nr_observations()</span>
<span class="sd">        5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_obs</span><span class="p">)</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nr_years</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=np.linspace(1., 2., 366),</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2018-12-31&#39;, periods=366, freq=&#39;D&#39;),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.nr_years()</span>
<span class="sd">        1.0</span>
<span class="sd">        &gt;&gt;&gt; prices.squeeze().nr_years()</span>
<span class="sd">        1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_calendar_days</span><span class="p">()</span> <span class="o">/</span> <span class="mi">365</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cagr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=np.linspace(1., 1.5, 366),</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2018-12-31&#39;, periods=366, freq=&#39;D&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.cagr()</span>
<span class="sd">        S&amp;P 500    0.5</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; prices.squeeze().cagr()</span>
<span class="sd">        np.float64(0.5)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
        <span class="n">years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_years</span><span class="p">()</span>
        <span class="n">cagr</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">level</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">cagr</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cumulative_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=np.linspace(1., 1.5, 10),</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2018-12-31&#39;, periods=10, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.cumulative_return()</span>
<span class="sd">                     S&amp;P 500</span>
<span class="sd">        2018-12-31  0.000000</span>
<span class="sd">        2019-01-01  0.055556</span>
<span class="sd">        2019-01-02  0.111111</span>
<span class="sd">        2019-01-03  0.166667</span>
<span class="sd">        2019-01-04  0.222222</span>
<span class="sd">        2019-01-07  0.277778</span>
<span class="sd">        2019-01-08  0.333333</span>
<span class="sd">        2019-01-09  0.388889</span>
<span class="sd">        2019-01-10  0.444444</span>
<span class="sd">        2019-01-11  0.500000</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="n">level_start</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">level</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">level</span> <span class="o">/</span> <span class="n">level_start</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">overall_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_return</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=np.linspace(1., 1.5, 10),</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2018-12-31&#39;, periods=10, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.volatility()</span>
<span class="sd">        S&amp;P 500    0.092578</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; prices.squeeze().volatility()</span>
<span class="sd">        np.float64(0.092578...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BDAYS</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=6, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.drawdown()</span>
<span class="sd">                     S&amp;P 500</span>
<span class="sd">        2019-01-01  0.000000</span>
<span class="sd">        2019-01-02  0.000000</span>
<span class="sd">        2019-01-03  0.000000</span>
<span class="sd">        2019-01-04 -0.038835</span>
<span class="sd">        2019-01-07 -0.009709</span>
<span class="sd">        2019-01-08  0.000000</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">level</span> <span class="o">/</span> <span class="n">level</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=6, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.max_drawdown()</span>
<span class="sd">        S&amp;P 500   -0.038835</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value_at_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.value_at_risk(quantile=0.025)</span>
<span class="sd">        S&amp;P 500   -0.037379</span>
<span class="sd">        Name: 0.025, dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simple_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">simple_returns</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">quantile</span><span class="p">)</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">expected_shortfall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.expected_shortfall(quantile=0.025)</span>
<span class="sd">        S&amp;P 500   -0.038835</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simple_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">quantile</span><span class="p">)</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="n">simple_returns</span> <span class="o">&lt;=</span> <span class="n">value_at_risk</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">downside_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.downside_volatility()</span>
<span class="sd">        S&amp;P 500    0.149522</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simple_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="n">neg_returns</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="n">simple_returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BDAYS</span><span class="p">)</span> <span class="o">*</span> <span class="n">neg_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upside_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.upside_volatility()</span>
<span class="sd">        S&amp;P 500    0.154643</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simple_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="n">pos_returns</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="n">simple_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BDAYS</span><span class="p">)</span> <span class="o">*</span> <span class="n">pos_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">martin_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.martin_risk()</span>
<span class="sd">        S&amp;P 500    0.024513</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># http://www.tangotools.com/ui/ui.htm</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Ulcer_index</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="p">()</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tracking_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data={</span>
<span class="sd">        ...         &#39;S&amp;P 500&#39;: [1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...         &#39;SPY&#39;: [1., 1.011, 1.0298, 0.991, 1.0208, 1.031, 1., 0.979],</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices[&#39;S&amp;P 500&#39;].tracking_error(prices[&#39;SPY&#39;])</span>
<span class="sd">        np.float64(0.01536269...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">excess_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_returns</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BDAYS</span><span class="p">)</span> <span class="o">*</span> <span class="n">excess_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">NDFrame</span><span class="p">):</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cagr</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rate</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">excess_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data={</span>
<span class="sd">        ...         &#39;S&amp;P 500&#39;: (1, 1.15, 1.18, 1.12),</span>
<span class="sd">        ...         &#39;RiskFreeRate&#39;: (1, 1.02, 1.03, 1.04),</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=4, freq=&#39;D&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;, &#39;RiskFreeRate&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices[&#39;S&amp;P 500&#39;].excess_returns(prices[&#39;RiskFreeRate&#39;])</span>
<span class="sd">        2019-01-02    0.130000</span>
<span class="sd">        2019-01-03    0.016283</span>
<span class="sd">        2019-01-04   -0.060556</span>
<span class="sd">        Freq: D, dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">self_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="n">other_returns</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">self_returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">self_returns</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">other_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">excess_returns</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">excess_cagr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">over</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data={</span>
<span class="sd">        ...         &#39;S&amp;P 500&#39;: np.linspace(1, 1.15, 366),</span>
<span class="sd">        ...         &#39;RiskFreeRate&#39;: np.linspace(1, 1.02, 366),</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=366, freq=&#39;D&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;, &#39;RiskFreeRate&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.excess_cagr(over=0.) == prices.cagr()</span>
<span class="sd">        S&amp;P 500         True</span>
<span class="sd">        RiskFreeRate    True</span>
<span class="sd">        dtype: bool</span>
<span class="sd">        &gt;&gt;&gt; prices.excess_cagr(over=0.02).round(6)</span>
<span class="sd">        S&amp;P 500         0.13</span>
<span class="sd">        RiskFreeRate    0.00</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cagr</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rate</span><span class="p">(</span><span class="n">over</span><span class="p">)</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sharpe_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data={</span>
<span class="sd">        ...         &#39;S&amp;P 500&#39;: [1., 1.01, 1.03, 1.03, 1., 1.01],</span>
<span class="sd">        ...         &#39;RiskFreeRate&#39;: [1., 1.001, 1005, 1.006, 1.009, 1.01],</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=6, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;, &#39;RiskFreeRate&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.sharpe_ratio(risk_free=prices[&#39;RiskFreeRate&#39;])</span>
<span class="sd">        S&amp;P 500         0.0</span>
<span class="sd">        RiskFreeRate    0.0</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; prices.sharpe_ratio(risk_free=prices[&#39;RiskFreeRate&#39;].cagr())</span>
<span class="sd">        S&amp;P 500         0.0</span>
<span class="sd">        RiskFreeRate    0.0</span>
<span class="sd">        dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data={</span>
<span class="sd">        ...         &#39;S&amp;P 500&#39;: [1., 1.01, 1.03, 1.03, 1., 1.03],</span>
<span class="sd">        ...         &#39;RiskFreeRate&#39;: [1., 1.001, 1005, 1.007, 1.009, 1.01],</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=6, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;, &#39;RiskFreeRate&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices[&#39;S&amp;P 500&#39;].sharpe_ratio(risk_free=prices[&#39;RiskFreeRate&#39;])</span>
<span class="sd">        np.float64(8.31680812940463)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sortino_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.DataFrame(</span>
<span class="sd">        ...     data={</span>
<span class="sd">        ...         &#39;S&amp;P 500&#39;: [1., 1.01, 1.02, 1.05, 1.03, 1.02],</span>
<span class="sd">        ...         &#39;RiskFreeRate&#39;: [1., 1.001, 1005, 1.007, 1.009, 1.01],</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=6, freq=&#39;B&#39;),</span>
<span class="sd">        ...     columns=[&#39;S&amp;P 500&#39;, &#39;RiskFreeRate&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices[&#39;S&amp;P 500&#39;].sortino_ratio(risk_free=prices[&#39;RiskFreeRate&#39;])</span>
<span class="sd">        np.float64(10.7621879372323)</span>
<span class="sd">        &gt;&gt;&gt; risk_free_cagr = prices[&#39;RiskFreeRate&#39;].cagr()</span>
<span class="sd">        &gt;&gt;&gt; risk_free_cagr</span>
<span class="sd">        np.float64(0.6800754114925203)</span>
<span class="sd">        &gt;&gt;&gt; prices[&#39;S&amp;P 500&#39;].sortino_ratio(risk_free_cagr)</span>
<span class="sd">        np.float64(10.7621879372323)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downside_volatility</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">information_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">benchmark</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking_error</span><span class="p">(</span><span class="n">benchmark</span><span class="p">)</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calmar_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">martin_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># http://www.tangotools.com/ui/ui.htm</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Ulcer_index</span>
        <span class="c1"># https://www.keyquant.com/Download/GetFile?Filename=%5CPublications%5CKeyQuant_WhitePaper_APT_Part1.pdf</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">martin_risk</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">omega_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Code from aric.</span>
        <span class="c1"># I&#39;m not convinced with data quality and wouldn&#39;t trust the output.</span>
        <span class="c1">#if isinstance(risk_free, Number):</span>
        <span class="c1">#    risk_free = self.make_series_from_cagr(risk_free, &quot;RiskFree&quot;)</span>
        <span class="n">risk_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rate</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">risk_free</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">BDAYS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">lpm</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
            <span class="c1"># This method returns a lower partial moment of the returns</span>
            <span class="c1"># Create an array he same length as returns containing the minimum return threshold</span>
            <span class="c1">#threshold_array = np.empty(len(returns))</span>
            <span class="c1">#threshold_array.fill(threshold)</span>
            <span class="c1"># Calculate the difference between the threshold and the returns</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">-</span> <span class="n">returns</span>
            <span class="c1"># Set the minimum of each to 0</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Return the sum of the different to the power of order</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff</span> <span class="o">**</span> <span class="n">order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BDAYS</span><span class="p">)</span>

        <span class="n">excess_cagr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">excess_cagr</span> <span class="o">/</span> <span class="n">lpm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">(),</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">capm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RegressionResultsWrapper</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a regression for each asset (column) of self.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">risk_free</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="n">risk_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_series_from_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">,</span> <span class="s2">&quot;RiskFree&quot;</span><span class="p">)</span>
        <span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">benchmark</span><span class="o">.</span><span class="n">excess_returns</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">excess_returns</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span>
        <span class="n">common_idx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">linear_regression</span> <span class="o">=</span> <span class="n">OLS</span><span class="p">(</span>
            <span class="n">endog</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">],</span>
            <span class="n">exog</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">],</span>
            <span class="n">hasconst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">linear_regression</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_series_from_cagr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cagr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cagr : float</span>
<span class="sd">            Annualized compounded growth rate of the series that you want</span>
<span class="sd">            to get.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the returned pd.Series.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Returns a series with the same index and values corresponding to</span>
<span class="sd">        a level series growing at the specified rate.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; series = pd.Series(index=pd.date_range(&#39;2019-01-01&#39;, periods=BDAYS+1), dtype=float)</span>
<span class="sd">        &gt;&gt;&gt; prices = series.make_series_from_cagr(0.01)</span>
<span class="sd">        &gt;&gt;&gt; prices.head()</span>
<span class="sd">        2019-01-01    1.000000</span>
<span class="sd">        2019-01-02    1.000039</span>
<span class="sd">        2019-01-03    1.000079</span>
<span class="sd">        2019-01-04    1.000118</span>
<span class="sd">        2019-01-05    1.000158</span>
<span class="sd">        Freq: D, dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; prices.tail()</span>
<span class="sd">        2019-09-06    1.00984</span>
<span class="sd">        2019-09-07    1.00988</span>
<span class="sd">        2019-09-08    1.00992</span>
<span class="sd">        2019-09-09    1.00996</span>
<span class="sd">        2019-09-10    1.01000</span>
<span class="sd">        Freq: D, dtype: float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rate_daily</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cagr</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">BDAYS</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rate_daily</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns alpha coefficient of CAPM regression.&quot;&quot;&quot;</span>
        <span class="n">capm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capm</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">capm</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="n">BDAYS</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns beta coefficient of CAPM regression.&quot;&quot;&quot;</span>
        <span class="n">capm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capm</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">capm</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_intersect_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDFrame</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">returns_by_month</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a DataFrame with monthly returns by year and month.</span>

<span class="sd">        Examples</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; import tradingenv</span>
<span class="sd">        &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">        &gt;&gt;&gt; series = pd.Series(index=pd.date_range(&#39;2019-01-01&#39;, periods=252*3), dtype=float)</span>
<span class="sd">        &gt;&gt;&gt; prices = series.make_series_from_cagr(0.01).to_frame()</span>
<span class="sd">        &gt;&gt;&gt; returns_by_month = prices.returns_by_month()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)),</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">months</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@to_pandas</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tearsheet</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">benchmark</span><span class="p">:</span> <span class="n">NDFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">risk_free</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">NDFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prices</span><span class="p">:</span> <span class="n">NDFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a tearsheet using daily finacial time series.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        benchmark : NDFrame</span>
<span class="sd">            A NDFrame representing the levels series that you want to use to</span>
<span class="sd">            benchmark your investment strategy. This argument is mostly used</span>
<span class="sd">            when rendering the environment or calculating tearsheets.</span>
<span class="sd">        risk_free : Union[NDFrame, float]</span>
<span class="sd">            Risk free rate of the market (e.g. T-Bills, EURIBOR) expressed as</span>
<span class="sd">            a level pandas Series or DataFrame.</span>
<span class="sd">        weights : NDFrame</span>
<span class="sd">            Historical weights weights of the strategy. These can be found in</span>
<span class="sd">            TrackRecord.target_weights.</span>
<span class="sd">        prices : pd.DataFrame</span>
<span class="sd">            A pandas.DataFrame whose columns are asset _names, index are</span>
<span class="sd">            timestamps and values are prices.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A pd.DataFrame with several return, risk and risk-adjusted return</span>
<span class="sd">        metrics.</span>

<span class="sd">        Examples</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; returns = pd.DataFrame(</span>
<span class="sd">        ...     data=np.random.normal(0, 0.01, (1000, 3)),</span>
<span class="sd">        ...     index=pd.date_range(&#39;2010&#39;, freq=&#39;D&#39;, periods=1000),</span>
<span class="sd">        ...     columns=[&#39;Strategy&#39;, &#39;S&amp;P 500&#39;, &#39;T-Notes&#39;]</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; level = (1 + returns).cumprod()</span>
<span class="sd">        &gt;&gt;&gt; tearsheet = level[&#39;Strategy&#39;].tearsheet(</span>
<span class="sd">        ...     benchmark=level[&#39;S&amp;P 500&#39;],</span>
<span class="sd">        ...     risk_free=level[&#39;T-Notes&#39;],</span>
<span class="sd">        ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">risk_free</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="n">risk_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_series_from_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">,</span> <span class="s2">&quot;RiskFree&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: test tearsheet</span>
        <span class="c1"># Ensure that we analyse data over the same time span (daily data)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">prices</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">risk_free</span> <span class="o">=</span> <span class="n">risk_free</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Construct the tearsheet.</span>
        <span class="n">tearsheet</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;From&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;To&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Years&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_years</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Observations&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_observations</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Risk-free asset&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">risk_free</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Risk-free CAGR&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rate</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Return&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cagr</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Return&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR over cash&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span><span class="n">risk_free</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Return&quot;</span><span class="p">,</span> <span class="s2">&quot;Overall return&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_return</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Volatility&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Downside volatility&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downside_volatility</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Upside volatility&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upside_volatility</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Max drawdown&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Martin risk&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">martin_risk</span><span class="p">()</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;VaR 5%&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_at_risk</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;VaR 2%&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_at_risk</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Expected shortfall 5%&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_shortfall</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk&quot;</span><span class="p">,</span> <span class="s2">&quot;Expected shortfall 2%&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_shortfall</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk-adjusted return&quot;</span><span class="p">,</span> <span class="s2">&quot;Sharpe ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpe_ratio</span><span class="p">(</span>
            <span class="n">risk_free</span>
        <span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk-adjusted return&quot;</span><span class="p">,</span> <span class="s2">&quot;Sortino ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortino_ratio</span><span class="p">(</span>
            <span class="n">risk_free</span>
        <span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk-adjusted return&quot;</span><span class="p">,</span> <span class="s2">&quot;Calmar ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calmar_ratio</span><span class="p">(</span>
            <span class="n">risk_free</span>
        <span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk-adjusted return&quot;</span><span class="p">,</span> <span class="s2">&quot;Martin ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">martin_ratio</span><span class="p">(</span>
            <span class="n">risk_free</span>
        <span class="p">)</span>
        <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Risk-adjusted return&quot;</span><span class="p">,</span> <span class="s2">&quot;Omega ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_ratio</span><span class="p">(</span>
            <span class="n">risk_free</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">benchmark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Outperformance&quot;</span><span class="p">,</span> <span class="s2">&quot;Benchmark id&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">benchmark</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Outperformance&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR over benchmark&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excess_cagr</span><span class="p">(</span>
                <span class="n">benchmark</span>
            <span class="p">)</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Outperformance&quot;</span><span class="p">,</span> <span class="s2">&quot;Information ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">information_ratio</span><span class="p">(</span>
                <span class="n">benchmark</span>
            <span class="p">)</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Outperformance&quot;</span><span class="p">,</span> <span class="s2">&quot;CAPM Alpha&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">(</span>
                <span class="n">benchmark</span><span class="p">,</span> <span class="n">risk_free</span>
            <span class="p">)</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Outperformance&quot;</span><span class="p">,</span> <span class="s2">&quot;CAPM Beta&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">)</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Outperformance&quot;</span><span class="p">,</span> <span class="s2">&quot;Correlation&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">benchmark</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">leverage</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">turnover</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Weights&quot;</span><span class="p">,</span> <span class="s2">&quot;Leverage mean&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">leverage</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Weights&quot;</span><span class="p">,</span> <span class="s2">&quot;Turnover daily&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">turnover</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Weights&quot;</span><span class="p">,</span> <span class="s2">&quot;Turnover annual&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BDAYS</span> <span class="o">*</span> <span class="n">turnover</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">asset_name</span><span class="p">,</span> <span class="n">weight_avg</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Weights&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">asset_name</span><span class="p">))]</span> <span class="o">=</span> <span class="n">weight_avg</span>
        <span class="k">if</span> <span class="n">prices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">asset</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># avoid stuff like cash</span>
                    <span class="n">tearsheet</span><span class="p">[(</span><span class="s2">&quot;Markets&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))]</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cagr</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">tearsheet</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SeriesMetrics</span><span class="p">(</span><span class="n">NDFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define here methods to be added to pandas.Series. All these methods</span>
<span class="sd">    assume that data are daily levels.&quot;&quot;&quot;</span>

    <span class="nd">@to_pandas</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">drawdown_periods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.Series(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     name=&#39;S&amp;P 500&#39;,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; prices.drawdown_periods()</span>
<span class="sd">           Max drawdown       From     Trough         To  Nr days</span>
<span class="sd">        1     -0.048544 2019-01-09 2019-01-10 2019-01-10        2</span>
<span class="sd">        0     -0.038835 2019-01-04 2019-01-04 2019-01-07        2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="p">()</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">drawdown</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="n">group_ids</span><span class="p">[</span><span class="n">drawdown</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)</span>
        <span class="n">drawdown_periods</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Max drawdown&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="s2">&quot;From&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">series</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;Trough&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="o">.</span><span class="n">idxmin</span><span class="p">(),</span>
                <span class="s2">&quot;To&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">series</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;Nr days&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">drawdown_periods</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">drawdown_periods</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Max drawdown&quot;</span><span class="p">)</span>

    <span class="nd">@to_pandas</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">linear_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_index</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; prices = pd.Series(</span>
<span class="sd">        ...     data=[1., 1.01, 1.03, 0.99, 1.02, 1.03, 1., 0.98],</span>
<span class="sd">        ...     index=pd.date_range(start=&#39;2019-01-01&#39;, periods=8, freq=&#39;B&#39;),</span>
<span class="sd">        ...     name=&#39;S&amp;P 500&#39;,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; trendline = prices.linear_regression(reset_index=True)</span>
<span class="sd">        &gt;&gt;&gt; trendline[&#39;trendline&#39;]</span>
<span class="sd">        2019-01-01    1.014167</span>
<span class="sd">        2019-01-02    1.012262</span>
<span class="sd">        2019-01-03    1.010357</span>
<span class="sd">        2019-01-04    1.008452</span>
<span class="sd">        2019-01-07    1.006548</span>
<span class="sd">        2019-01-08    1.004643</span>
<span class="sd">        2019-01-09    1.002738</span>
<span class="sd">        2019-01-10    1.000833</span>
<span class="sd">        Freq: B, dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; trendline[&#39;residuals&#39;]</span>
<span class="sd">        2019-01-01   -0.014167</span>
<span class="sd">        2019-01-02   -0.002262</span>
<span class="sd">        2019-01-03    0.019643</span>
<span class="sd">        2019-01-04   -0.018452</span>
<span class="sd">        2019-01-07    0.013452</span>
<span class="sd">        2019-01-08    0.025357</span>
<span class="sd">        2019-01-09   -0.002738</span>
<span class="sd">        2019-01-10   -0.020833</span>
<span class="sd">        Freq: B, dtype: float64</span>
<span class="sd">        &gt;&gt;&gt; trendline[&#39;std&#39;]  # doctest: +ELLIPSIS</span>
<span class="sd">        0.01771850...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">reset_index</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;constant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">ols</span> <span class="o">=</span> <span class="n">OLS</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">hasconst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ols_results</span> <span class="o">=</span> <span class="n">ols</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">ols_results</span><span class="p">,</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;trendline&quot;</span><span class="p">:</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;residuals&quot;</span><span class="p">:</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ols_results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span>
        <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DataFrameMetrics</span><span class="p">(</span><span class="n">NDFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define here methods to be added to pandas.Series. All these methods</span>
<span class="sd">    assume that data are daily levels.&quot;&quot;&quot;</span>

    <span class="nd">@to_pandas</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns covariance matrix of simple returns.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>

    <span class="nd">@to_pandas</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clustering</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns correlation matrix. If clustering=True, the correlation</span>
<span class="sd">        matrix will be sorted accoring to the clusters and clusters will be</span>
<span class="sd">        returned.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_returns</span><span class="p">()</span>
        <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clustering</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">corr_mat</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">linkages</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">fcluster</span><span class="p">(</span><span class="n">linkages</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s2">&quot;distance&quot;</span><span class="p">)</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">corr_mat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
            <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Formatting of clusters.</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">==</span> <span class="n">i</span>
                <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">corr_mat</span><span class="p">,</span> <span class="n">clusters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">corr_mat</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Federico Fontana.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>