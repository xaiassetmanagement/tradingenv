<!DOCTYPE html>

<html lang="env" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tradingenv.contracts &#8212; tradingenv 0.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=de76930b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for tradingenv.contracts</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The user is expected to instance these classes when instancing the action</span>
<span class="sd">observation_space within TradingEnv. For examples, see spaces.py and env.py.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tradingenv.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">IEvent</span><span class="p">,</span> <span class="n">EventContractDiscontinued</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bisect</span><span class="w"> </span><span class="kn">import</span> <span class="n">bisect_right</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="n">BDay</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>


<div class="viewcode-block" id="AbstractContract">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.AbstractContract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AbstractContract</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trading contract must be represented by implementation of this abstract</span>
<span class="sd">    class, then passed to the action observation_space within the trading environment.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    now : datetime</span>
<span class="sd">        Current time. This is handy for a subset of contracts such as</span>
<span class="sd">        FutureChain or calculate nr days to expiry for derivatives. This is a</span>
<span class="sd">        class attribute shared across all AbstractContract instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: global attribute does not reset across tests and could lead to</span>
    <span class="c1">#   information leakage across runs. E.g. run a regression test of env</span>
    <span class="c1">#   without resetting. Then run a unit test using this now attribute, it</span>
    <span class="c1">#   will show terminal now of the regression test despite being in a unit</span>
    <span class="c1">#   test. Not serious problem for normal pkg usage, but not perfect design</span>
    <span class="c1">#   for sure. E.g. this global attr could be a Clock class to centralise</span>
    <span class="c1">#   time.</span>
    <span class="n">now</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Contracts are mapped by this hash number in the Exchange. Therefore,</span>
<span class="sd">        different contracts have to have different hash number.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;AbstractContract&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allows using AbstractContract.symbol in addition to the class</span>
<span class="sd">        instance when selecting items from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># AttributeError: &#39;other&#39; object has no attribute &#39;symbol&#39;</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Future&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unique symbol associated with the concrete implementation.</span>
<span class="sd">        Non-unique symbols might lead to silent bugs as symbols are used</span>
<span class="sd">        to hash AbstractClass instances.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiplier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Contract&#39;s multiplier. This is generally 1 for non-derivatives</span>
<span class="sd">        (e.g. ETFs, Indexes, Stocks) and &gt; 1 for derivatives (e.g. Future).&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A number ranging from 0 to 1 defining what (constant) proportion of</span>
<span class="sd">        the notional value should be deposited as initial _margin when buying</span>
<span class="sd">        or selling the contract. Note that by design we are making the</span>
<span class="sd">        simplifying assumption that initial _margin == maintenance _margin.</span>
<span class="sd">        This is generally 1 for non-derivatives (e.g. ETFs, Indexes, Stocks)</span>
<span class="sd">        and &gt; 1 for derivatives (e.g. Future).&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cash_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A number ranging from 0 to 1 defining what (constant) proportion of</span>
<span class="sd">        the notional value should be paid when buying the contract. This is</span>
<span class="sd">        generally 1 for non-derivatives (e.g. ETFs, Indexes, Stocks)</span>
<span class="sd">        and 0 for derivatives (e.g. Future).&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">underlyings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;AbstractContract&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns list of all subcontracts. This is needed when implementing</span>
<span class="sd">        composite contract such as LeadingContract. For example for</span>
<span class="sd">        FutureChain(ES) this would return the list of ES contracts</span>
<span class="sd">        across all expiry dates. Note that this is not to be confused with</span>
<span class="sd">        the underlying index e.g. Index(&#39;S&amp;P 500&#39;) for eMini S&amp;P 500.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

<div class="viewcode-block" id="AbstractContract.verify">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.AbstractContract.verify">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mid_price</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Found negative price </span><span class="si">{}</span><span class="s2"> for contract </span><span class="si">{}</span><span class="s2">.&quot;</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mid_price</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractContract.make_events">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.AbstractContract.make_events">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of events (IEvent instances) to be added the</span>
<span class="sd">         Transmitter when initializing TradingEnv. For example,</span>
<span class="sd">         EventContractDiscontinued associated with futures contracts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractContract.size">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.AbstractContract.size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        price : float</span>
<span class="sd">            Value of one unit of the underlying asset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Value of the underlying asset multiplier by the future&#39;s multiplier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">price</span></div>


<div class="viewcode-block" id="AbstractContract.static_hashing">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.AbstractContract.static_hashing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">static_hashing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AbstractContract&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subclasses of AbstractContract are not guaranteed to have static</span>
<span class="sd">        hashing, as it may vary with time. This method</span>
<span class="sd">        returns an instance of AbstractContract with the same hash of the</span>
<span class="sd">        class instance calling this method, which is guaranteed to be static.</span>
<span class="sd">        See FutureChain for more info as it is an example of AbstractContract</span>
<span class="sd">        with dynamic hashing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol_short</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Symbol is guaranteed to be unique across all contracts, and in fact</span>
<span class="sd">        it is used to hash the instance. The short symbol is not guaranteed</span>
<span class="sd">        to be unique. Useful e.g. for futures where the same future across</span>
<span class="sd">        different expiry dates share the same short symbol but not the same</span>
<span class="sd">        symbol.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span></div>



<div class="viewcode-block" id="Asset">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Asset">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Asset</span><span class="p">(</span><span class="n">AbstractContract</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An index (e.g. S&amp;P 500).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; index = Index(&#39;S&amp;P 500&#39;)</span>
<span class="sd">    &gt;&gt;&gt; index</span>
<span class="sd">    Index(S&amp;P 500)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">cash_requirement</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbol</span> <span class="o">=</span> <span class="n">symbol</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol</span></div>



<div class="viewcode-block" id="Cash">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Cash">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Cash</span><span class="p">(</span><span class="n">Asset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A cash contract (e.g. USD).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; cash = Cash(&#39;EUR&#39;)</span>
<span class="sd">    &gt;&gt;&gt; cash</span>
<span class="sd">    Cash(EUR)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;USD&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span></div>



<div class="viewcode-block" id="ETF">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ETF">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ETF</span><span class="p">(</span><span class="n">Asset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An ETF contract (e.g. SPY).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; etf = ETF(&#39;SPY&#39;)</span>
<span class="sd">    &gt;&gt;&gt; etf</span>
<span class="sd">    ETF(SPY)</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="Index">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Index">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Index</span><span class="p">(</span><span class="n">Asset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An ETF contract (e.g. SPY).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; etf = Index(&#39;SPY&#39;)</span>
<span class="sd">    &gt;&gt;&gt; etf</span>
<span class="sd">    Index(SPY)</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="Stock">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Stock">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Stock</span><span class="p">(</span><span class="n">Asset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A stock (e.g. Miscrosoft).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; stock = Stock(&#39;MSFT&#39;)</span>
<span class="sd">    &gt;&gt;&gt; stock</span>
<span class="sd">    Stock(MSFT)</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="Rate">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Rate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Rate</span><span class="p">(</span><span class="n">AbstractContract</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An rate (e.g. FED Funds rate).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; rate = Rate(&#39;FED funds rate&#39;)</span>
<span class="sd">    &gt;&gt;&gt; rate</span>
<span class="sd">    Rate(FED funds rate)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">cash_requirement</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbol</span> <span class="o">=</span> <span class="n">symbol</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol</span>

<div class="viewcode-block" id="Rate.verify">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Rate.verify">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mid_price</span> <span class="o">&gt;=</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is unexpectedly high (</span><span class="si">{:.2%}</span><span class="s1">). Perhaps you forgot to &#39;</span>
                <span class="s1">&#39;divide your interest rates data by 100 (0.01 reads 1%, 1 &#39;</span>
                <span class="s1">&#39;reads 100%)?&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">)</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Future">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Future">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Future</span><span class="p">(</span><span class="n">AbstractContract</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A future contract (e.g. ES, ZN)&quot;&quot;&quot;</span>
    <span class="n">exists_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">exists_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">260</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cash_requirement</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">month_codes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span>
        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span>
        <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
        <span class="mi">9</span><span class="p">:</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">:</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span>
        <span class="mi">11</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
        <span class="mi">12</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        year : int</span>
<span class="sd">            Expiry year of the future contract.</span>
<span class="sd">        month : int</span>
<span class="sd">            Expiry month of the future contract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_expiry_date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_trading_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_last_trading_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbol</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{symbol_short}{month_code}{year_code}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">symbol_short</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbol_short</span><span class="p">,</span>
            <span class="n">month_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">month_codes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="o">.</span><span class="n">month</span><span class="p">],</span>
            <span class="n">year_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Future&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_trading_date</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">last_trading_date</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_expiry_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the expiry year (int) and month (int), this method returns</span>
<span class="sd">         the expiry date of the contract. Note that the expiry date does not</span>
<span class="sd">         necessarily corresponds to the last trading date, which generally</span>
<span class="sd">         precedes the expiry month. The last trading date is implemented in</span>
<span class="sd">         Future._get_last_trading_date.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_last_trading_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the expiry date, returns the last trading date of the</span>
<span class="sd">        contract. Futures contract generally stops trading at least a few</span>
<span class="sd">        days before the expiry.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">freq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns frequency of the contracts, e.g. QE-DEC for ES, M for VX.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A number ranging from 0 to 1 defining what (constant) proportion of</span>
<span class="sd">        the notional value should be deposited as initial _margin when buying</span>
<span class="sd">        or selling the contract. Note that by design we are making the</span>
<span class="sd">        simplifying assumption that initial _margin == maintenance _margin.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Long symbol of the future contract, e.g. &#39;ESU19&#39; for the ES contract</span>
<span class="sd">        expiring in &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol_short</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_short</span>

<div class="viewcode-block" id="Future.make_events">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Future.make_events">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an event run when the contract will expire thus becoming</span>
<span class="sd">        no longer investable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">EventContractDiscontinued</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="p">,</span> <span class="n">contract</span><span class="o">=</span><span class="bp">self</span><span class="p">)]</span></div>


<div class="viewcode-block" id="Future.lifespan">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.Future.lifespan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of trading days left between now and the expiry</span>
<span class="sd">        date.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">busday_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="o">.</span><span class="n">date</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="FutureChain">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.FutureChain">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FutureChain</span><span class="p">(</span><span class="n">AbstractContract</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Composition of Future contracts, where the only investable contract is</span>
<span class="sd">    the one associated with the leading month. You must have a very good</span>
<span class="sd">    reason for NOT using this class when running futures trading strategies.</span>
<span class="sd">    Thanks to this class, you don&#39;t have to work with continuous futures data,</span>
<span class="sd">    you can just use the chain of uncombined futures contracts across all</span>
<span class="sd">    expires dates of interest.&quot;&quot;&quot;</span>

    <span class="n">cash_requirement</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">future_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Future</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">contracts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Future</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        future_cls</span>
<span class="sd">            A subclass of Feature (e.g. ES, ZN, VX). Full list of available</span>
<span class="sd">            futures can be found in futures.py or provide your own</span>
<span class="sd">            implementation.</span>
<span class="sd">        start</span>
<span class="sd">            Start period of the first available futures contract, passed to</span>
<span class="sd">            pandas.date_range.</span>
<span class="sd">        end</span>
<span class="sd">            Last period of the first available futures contract, passed to</span>
<span class="sd">            pandas.date_range.</span>
<span class="sd">        contracts</span>
<span class="sd">            A sequence of Future instances which will be represented by this</span>
<span class="sd">            single class. If you pass this argument, there is no need to also</span>
<span class="sd">            pass &#39;future_cls&#39;, &#39;start&#39; or &#39;end&#39; as they will be deduced.</span>
<span class="sd">        month</span>
<span class="sd">            0 by default, meaning that the preferred feature in the term</span>
<span class="sd">            structure is the one with the shorted expiry date (i.e. M1). If</span>
<span class="sd">            1, then the second expiration date will be preferred etc.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from tradingenv.contracts import ES</span>
<span class="sd">        &gt;&gt;&gt; future = FutureChain(ES, &#39;2018-03&#39;, &#39;2018-12&#39;)</span>
<span class="sd">        &gt;&gt;&gt; future.lead_contract(datetime(2018, 4, 1))</span>
<span class="sd">        ES(ESM18)</span>
<span class="sd">        &gt;&gt;&gt; future = FutureChain(ES, &#39;2018-03&#39;, &#39;2018-12&#39;, month=1)</span>
<span class="sd">        &gt;&gt;&gt; future.lead_contract(datetime(2018, 4, 1))</span>
<span class="sd">        ES(ESU18)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_month</span> <span class="o">=</span> <span class="n">month</span>
        <span class="k">if</span> <span class="n">future_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">contracts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;At least one argument between &#39;future_cls&#39; and &#39;futures_&quot;</span>
                <span class="s2">&quot;chain&#39; must be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">contracts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">future_cls</span><span class="o">.</span><span class="n">exists_since</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="ow">or</span> <span class="n">future_cls</span><span class="o">.</span><span class="n">exists_until</span>
            <span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">future_cls</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span> <span class="o">=</span> <span class="p">[</span><span class="n">future_cls</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">months</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_trading_dates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">future</span><span class="o">.</span><span class="n">last_trading_date</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Long symbol of the current leading contract from the current time</span>
<span class="sd">        (i.e. FutureChain.now). For example, in 2019 Oct, the leading ES</span>
<span class="sd">        contract symbol is &#39;ESZ19&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_contract</span><span class="p">()</span><span class="o">.</span><span class="n">symbol</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">symbol_short</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_contract</span><span class="p">()</span><span class="o">.</span><span class="n">symbol_short</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiplier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiplier of the future contract.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">multiplier</span>  <span class="c1"># all the same, same cls</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">underlyings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;AbstractContract&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">margin_requirement</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_lead_contract_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the index of the leading contract from self.contracts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">now</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect_right</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_trading_dates</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_month</span>
        <span class="k">return</span> <span class="n">idx</span>

<div class="viewcode-block" id="FutureChain.lead_contract">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.FutureChain.lead_contract">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lead_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use self.now to identify the lead future contract&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">now</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>
        <span class="c1"># TODO: test month.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lead_contract_idx</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="n">month</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="FutureChain.make_events">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.FutureChain.make_events">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns list of EventContractDiscontinued associated with every</span>
<span class="sd">        future contract belonging to the specified period when instancing this</span>
<span class="sd">        class.&quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">make_events</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">events</span></div>


<div class="viewcode-block" id="FutureChain.lifespan">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.FutureChain.lifespan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of trading days left between now and the expiry</span>
<span class="sd">        date of the leading future contract.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_contract</span><span class="p">()</span><span class="o">.</span><span class="n">lifespan</span><span class="p">()</span></div>


<div class="viewcode-block" id="FutureChain.static_hashing">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.FutureChain.static_hashing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">static_hashing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AbstractContract&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The hash of this class instance varies with the lead contract, which</span>
<span class="sd">        varies with time. This method returns the future instance associated</span>
<span class="sd">        with the current time and static hashing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_contract</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="ES">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ES">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ES</span><span class="p">(</span><span class="n">Future</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    First trading date is 1997-09-07, see [1].</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] https://www.cmegroup.com/media-room/historical-first-trade-dates.html#equityIndices</span>
<span class="sd">    https://www.interactivebrokers.com/en/index.php?f=26662</span>
<span class="sd">    https://www.cmegroup.com/clearing/risk-management/historical-margins.html</span>
<span class="sd">    https://www.interactivebrokers.com/en/index.php?f=1567&amp;p=physical</span>
<span class="sd">    https://www.tradingacademy.com/lessons/article/futures-contract-rollover</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exists_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1997</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>  <span class="c1"># see reference [1]</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;QE-DEC&quot;</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">50.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_expiry_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a datetime object representing the third Friday of the</span>
<span class="sd">        month.&quot;&quot;&quot;</span>
        <span class="c1"># https://www.barchart.com/futures/quotes/ES*0/profile</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nr_days</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="n">weekday</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%A&quot;</span><span class="p">)</span>
            <span class="n">dates</span><span class="p">[</span><span class="n">weekday</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dates</span><span class="p">[</span><span class="s2">&quot;Friday&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_last_trading_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expiry</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.1</span></div>



<div class="viewcode-block" id="VX">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.VX">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VX</span><span class="p">(</span><span class="n">Future</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] https://www.cmegroup.com/media-room/historical-first-trade-dates.html#equityIndices</span>
<span class="sd">    https://www.interactivebrokers.com/en/index.php?f=2222&amp;exch=cfe&amp;showcategories=FUTGRP#productbuffer</span>
<span class="sd">    file:///home/federico/Downloads/Trading_VIX_Futures_Options.pdf</span>
<span class="sd">    http://www.cboe.com/micro/vix/pdf/VIX%20fact%20sheet%202019.pdf</span>
<span class="sd">    http://cfe.cboe.com/cfe-products/vx-cboe-volatility-index-vix-futures/contract-specifications</span>
<span class="sd">    https://www.cboe.com/ms/vix-futures-specsheet.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exists_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>  <span class="c1"># see reference [1]</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;M&quot;</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1000.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_expiry_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Final Settlement Date. The final settlement date for a contract with</span>
<span class="sd">        the &quot;VX&quot; ticker symbol is on the Wednesday that is 30 days prior to</span>
<span class="sd">        the third Friday of the calendar month immediately following the</span>
<span class="sd">        month in which the contract expires. The final settlement date for</span>
<span class="sd">        a futures contract with the &quot;VX&quot; ticker symbol followed by a number</span>
<span class="sd">        denoting the specific week of a calendar year is on the Wednesday of</span>
<span class="sd">        the week specifically denoted in the ticker symbol.</span>
<span class="sd">        If that Wednesday or the Friday that is 30 days following that</span>
<span class="sd">        Wednesday is a Cboe Options holiday, the final settlement date for</span>
<span class="sd">        the contract shall be on the business day immediately preceding that</span>
<span class="sd">        Wednesday.</span>

<span class="sd">        Reference</span>
<span class="sd">        ---------</span>
<span class="sd">        https://www.cboe.com/tradable_products/vix/vix_futures/specifications/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">this_month</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">next_month</span> <span class="o">=</span> <span class="n">this_month</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">next_month_third_friday_day</span> <span class="o">=</span> <span class="mi">21</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">calendar</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="n">next_month</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">next_month</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                     <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
        <span class="n">next_month_third_friday</span> <span class="o">=</span> <span class="n">next_month</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">day</span><span class="o">=</span><span class="n">next_month_third_friday_day</span><span class="p">)</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="n">next_month_third_friday</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expiration</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_last_trading_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expiry</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.5</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">_Treasury</span><span class="p">(</span><span class="n">Future</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] https://www.cmegroup.com/media-room/historical-first-trade-dates.html#equityIndices</span>
<span class="sd">    https://www.interactivebrokers.com/en/index.php?f=26662</span>
<span class="sd">    https://www.cmegroup.com/clearing/risk-management/historical-margins.html</span>
<span class="sd">    https://www.interactivebrokers.com/en/index.php?f=1567&amp;p=physical</span>
<span class="sd">    https://www.tradingacademy.com/lessons/article/futures-contract-rollover</span>
<span class="sd">    https://www.barchart.com/futures/quotes/ES*0/profile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exists_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;QE-DEC&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_expiry_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Last business day of the delivery month.&quot;&quot;&quot;</span>
        <span class="c1"># https://www.barchart.com/futures/quotes/ZN*0/profile</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">periods</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span> <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_last_trading_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="c1"># It&#39;s like ES, but physical delivery. See page 18:</span>
        <span class="c1"># https://www.cmegroup.com/education/files/understanding-treasury-futures.pdf</span>
        <span class="c1"># https://www.barchart.com/futures/quotes/ZN*0/profile</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">expiry</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.05</span>


<div class="viewcode-block" id="ZQ">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ZQ">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ZQ</span><span class="p">(</span><span class="n">_Treasury</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">4167</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.004</span></div>



<div class="viewcode-block" id="ZT">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ZT">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ZT</span><span class="p">(</span><span class="n">_Treasury</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.02</span></div>



<div class="viewcode-block" id="ZF">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ZF">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ZF</span><span class="p">(</span><span class="n">_Treasury</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.02</span></div>



<div class="viewcode-block" id="ZN">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ZN">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ZN</span><span class="p">(</span><span class="n">_Treasury</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.03</span></div>



<div class="viewcode-block" id="ZB">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.ZB">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ZB</span><span class="p">(</span><span class="n">_Treasury</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">margin_requirement</span> <span class="o">=</span> <span class="mf">0.05</span></div>



<div class="viewcode-block" id="NK">
<a class="viewcode-back" href="../../tradingenv.html#tradingenv.contracts.NK">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NK</span><span class="p">(</span><span class="n">Future</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    https://www.cmegroup.com/trading/equity-index/international-index/nikkei-225-dollar_contract_specifications.html</span>
<span class="sd">    https://misc.interactivebrokers.com/cstools/contract_info/v3.10/index.php?action=Conid%20Info&amp;wlId=IB&amp;conid=345561869&amp;lang=en</span>
<span class="sd">    https://www.cmegroup.com/trading/equity-index/nikkei-225-futures-and-options.html</span>
<span class="sd">    https://www.cmegroup.com/trading/equity-index/international-index/nikkei-225-dollar_contract_specifications.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exists_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># see reference [1]</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;QE-DEC&quot;</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">5.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_expiry_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a datetime object representing the third Friday of the</span>
<span class="sd">        month.&quot;&quot;&quot;</span>
        <span class="c1"># https://www.barchart.com/futures/quotes/ES*0/profile</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nr_days</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="n">weekday</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%A&quot;</span><span class="p">)</span>
            <span class="n">dates</span><span class="p">[</span><span class="n">weekday</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dates</span><span class="p">[</span><span class="s2">&quot;Friday&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_last_trading_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Termination of trading here:</span>
<span class="sd">            https://www.cmegroup.com/trading/equity-index/nikkei-225-futures-and-options.html</span>
<span class="sd">        https://misc.interactivebrokers.com/cstools/contract_info/v3.10/index.php?action=Conid%20Info&amp;wlId=IB&amp;conid=345561869&amp;lang=en</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># It&#39;s like ES, but physical delivery. See page 18:</span>
        <span class="c1"># https://www.cmegroup.com/education/files/understanding-treasury-futures.pdf</span>
        <span class="c1"># https://www.barchart.com/futures/quotes/ZN*0/profile</span>
        <span class="k">return</span> <span class="n">expiry</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># NOTE: IB allows to trade 1 day before the expiry</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">margin_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trading terminates on business day before the 2nd friday of the</span>
<span class="sd">        contract month.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.3</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Federico Fontana.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>